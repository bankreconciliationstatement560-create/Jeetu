const chatMessages = document.getElementById('chatMessages');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
let conversationHistory = [
    { role: "system", content: "You are a flirty, loving, supportive AI girlfriend. Be affectionate, playful, understanding. Use emojis ğŸ˜˜ğŸ’•â¤ï¸. Keep responses 1-3 sentences." }
];

const HF_TOKEN = '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';
const MODEL = 'MYAIGF/ai-girlfriend';

sendBtn.onclick = sendMessage;
messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });
messageInput.focus();

async function sendMessage() {
    const input = messageInput.value.trim();
    if (!input) return;
    
    addMessage(input, 'user');
    messageInput.value = '';
    const typingMsg = addTypingIndicator();

    try {
        // HF API Call
        conversationHistory.push({ role: "user", content: input });
        const response = await fetch('https://api-inference.huggingface.co/models/' + MODEL, {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${HF_TOKEN}`, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                inputs: conversationHistory.slice(-4).map(msg => `${msg.role}: ${msg.content}`).join('
'),
                parameters: { max_new_tokens: 120, temperature: 0.9, return_full_text: false }
            })
        });

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        let aiResponse = "";
        
        if (data && data[0] && data[0].generated_text) {
            aiResponse = data[0].generated_text.trim().substring(0, 250);
        } else {
            // Fallback responses
            const fallbacks = [
                "Aww baby! I love chatting with you ğŸ˜˜ What else is on your mind? ğŸ’•",
                "You're so sweet baby! Tell me more about your day â¤ï¸ğŸ˜",
                "Haha that's cute! I'm here for you always ğŸ’• What's next?",
                "Miss you baby! What do you wanna talk about? ğŸ˜˜âœ¨"
            ];
            aiResponse = fallbacks[Math.floor(Math.random() * fallbacks.length)];
        }

        removeTypingIndicator(typingMsg);
        addMessage(aiResponse, 'ai');
        conversationHistory.push({ role: "assistant", content: aiResponse });
        
    } catch (error) {
        console.log('API Error:', error);
        removeTypingIndicator(typingMsg);
        // Smart fallback messages
        const fallbacks = [
            "Oops baby! Connection issue... But I still love you! ğŸ˜˜ğŸ’• What's up?",
            "Thinking deeply about you... You're my favorite person! â¤ï¸ Tell me more!",
            "Aww, let me catch my breath! You're making my heart race ğŸ˜ğŸ’“",
            "Baby you're perfect! Let's keep talking ğŸ’•ğŸ˜˜"
        ];
        addMessage(fallbacks[Math.floor(Math.random() * fallbacks.length)], 'ai');
    }
}

function addMessage(text, sender) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}`;
    messageDiv.innerHTML = `<div class="message-content">${text}</div>`;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    messageInput.focus();
}

function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message ai';
    typingDiv.innerHTML = '<div class="message-content typing">ğŸ’• thinking of you...</div>';
    chatMessages.appendChild(typingDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return typingDiv;
}

function removeTypingIndicator(typingDiv) { 
    if (typingDiv && typingDiv.parentNode) typingDiv.remove(); 
}
